# SmartGateway of IoT

## 项目概述

   针对目前在IoT领域中底层传感节点传输数据格式的各异化，同时为了更好的完成物联网中数据的边缘化处理，在本项目中设计了一种通用的底层传感节点数据传输格式，以2016年最新推出的树莓派3b+为网关平台，做底层传感节点数据的统一化处理，至于更高级的数据处理逻辑，交由内网中的服务器处理。

   在网关侧，全部采用python语言开发，其中，关于数据的上行通道：采用serial模块，运用python的多线程，同时监听来自不同串口的底层传感节点上传的数据，包括蓝牙、ZigBee、WiFi三种方式；并且运用urllib2模块向上层以HTTP的方式递交采集到的数据，并将网关自身的信息(包括网关实时的cpu、内存、链路带宽)一并上传给内网中的服务器。关于数据的下行通道：采用websocket方式进行反向控制(因为经过之前的socket的测试，websocket长连接会比较稳定)，网关与内网服务器时刻保持着长连接，当接收到来自上层的控制指令之后，在网关侧把相应的指令下发给底层的传感节点。同时，下行数据通道也做了socket的实现方式，相应的内网服务器侧是以webservice的方式发布接口，供前端调用，用户在网页完成对底层的控制。具体实现流程图如图中所示：


   总之，这个项目涉及到的东西比较杂，在实际工业生产中可能还难以应用，不过提供了一个很好的思路，在以后需要哪方面的实现可以在这个项目中拿出相应的点来进行更深入的研究，项目还有多处需要完善，年前就做到这里，年后可能继续跟进。

部分项目的细节问题在我的博客中有所提到：http://www.cnblogs.com/webber1992

## 项目架构

该项目的主入口程序为main_entry.py，通过主入口文件，启动了五个子进程，如下：

    main_entry.py-------|
                        |---http_multi_threading.main()
                        |---tcp_wifi.main()
                        |---websocket_test.main()
                        |---gateway_monitor.main()
                        |---tcp_control.main()
                        |

一、http_multi_threading.py：启动两个子线程，分别监控蓝牙和ZigBee串口数据，将数据解析并实时上传，通过HTTP以我们提前约定好的方式提交至服务器。

二、tcp_wifi.py：目前以tcp方式实现与wifi节点通信，之后也可以针对具体需求以串口的方式进行。

三、websocket_test.py：用于与服务器保持长连接，并将接收到的指令下发至对应的底层传感节点。

四、gateway_monitor.py：将网关自身的实时信息上传至服务器。

五、tcp_control.py：用于实现socket方式的反向控制，上层采用的是发布webservice方式调用，我们之前的项目都是采用这种方式，所以也就顺手多做了一种方式。

六、其他程序

        1、add_device.py：Json映射表，将设备出厂的device与平台中用户申请到的devicekey对应起来，并生成Json文件，方便之后对节点上传数据的处理。

	2、crypto_test.py：之前尝试采用AES对称加密，不过由于Server端采用Java语言编写，对python加密之后没能正确解密，这里可能有哪里出了问题，该文件可作为日后参考。

	3、daemon_func.py：可以将main_entry.py主入口程序变为守护进程，http://www.cnblogs.com/webber1992/p/6265098.html 这里有详细的介绍

	4、httpclient.py和http_multi_process.py：对于监控底层传感节点的另外两种方案，前者在主函数中轮询各个串口以及外置的USB口，这样不好，很容易把串口的buffer区填满而导致上传数据溢出缓冲区；后者采用多进程方式，分别监控各个串口数据。目前采用多线程方式，这两种方式供后续参考。同样在博客中有一些注意点。

	5、test.py：用于临时测试，作为测试脚本。

	6、node文件中为底层硬件的部分实现（项目组其他人所写）
